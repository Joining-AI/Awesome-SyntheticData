### 摘要
自动形式化（Autoformalization）是将自然语言数学转换为形式语言的过程，具有显著的潜力来推动数学推理的发展。然而，现有的努力主要集中在拥有大量在线语料的形式语言上，并且难以跟上快速发展的语言，如 Lean 4。为了解决这个问题，我们提出了一个新的基准 Formalization for Lean 4 (FormL4)，用于评估大型语言模型（LLMs）的自动形式化能力。这个基准包含了对问题、答案、形式陈述和证明的全面评估。此外，我们引入了一个过程监督验证器（PSV）模型，该模型利用 Lean 4 编译器的精确反馈来增强自动形式化。我们的实验表明，PSV 方法能够改进自动形式化，使用更少的过滤训练数据实现更高的准确性。此外，当使用包含详细过程信息的数据进行微调时，PSV 可以更有效地利用这些数据，从而显著提升 Lean 4 的自动形式化能力。我们的数据集和代码可在 https://github.com/rookie-joe/PDA 获取。

### 引言
自动形式化是将自然语言数学自动转换为形式语言的任务，具有革新数学推理的巨大潜力。它减少了形式化的高成本，并弥合了自动数学推理研究与大量自然语言数学知识之间的差距。

最近大型语言模型（LLMs）的进展显示出其在广泛任务中的强大能力，为自动形式化开辟了令人兴奋的可能性。尽管研究人员已经探索了使用少样本提示或在包含非正式和正式数学数据的大规模数据集上训练 LLMs，现有的努力仍局限于拥有大量在线语料的形式语言，例如 Lean 3。然而，社区最近将重点转移到 Lean 4，这是一种新的 Lean 定理证明器版本，解决了以前的限制并引入了用于高效编程的新功能。

Lean 4 的快速发展对自动形式化提出了重大挑战，因为跟上语言的不断变化的语法、语义、库和其他方面需要大量的专业知识和与社区的持续互动。这个挑战不仅对人类专家而且对 LLMs 都适用，因为缺乏专门针对 Lean 4 的训练数据和基准限制了它们的进展。为了解决这一问题，我们提出了一个新的基准，Formalization for Lean 4 (FormL4)，专门设计用于评估 LLMs 在 Lean 4 中的自动形式化能力。FormL4 包括问题、答案、形式陈述和证明，提供了对 LLMs 的全面评估。与现有数据集 MMA 不同，FormL4 提供了从自然语言问题和答案到 Lean 4 中的陈述和证明的“完整”自动形式化。这更具挑战性，因为它需要理解 Lean 4 的语法和每个证明中涉及的推理步骤。

形式语言的一个关键优势在于它们的编译器可以提供关于生成的证明的详细步骤级信息。通过 FormL4，我们可以充分利用 Lean 4 编译器的反馈，这种反馈更有价值，因为它包括语法检查和推理验证。这与仅关注翻译陈述而不包括证明的方法形成对比。编译器的过程信息为数学推理过程提供了宝贵的见解。最近的研究表明，过程信息在增强非正式语言的数学推理方面具有潜力。

基于这些进展，我们提出利用 Lean 4 编译器自然提供的精确反馈来改进自动形式化，如图1所示。我们的广泛实验表明，过程监督验证器（PSV）能够显著提升自动形式化器的性能，使其在使用更少过滤训练数据的情况下实现更高的自动形式化性能。此外，当 PSV 使用包含详细过程信息的高质量训练数据进行微调时，它可以更有效地利用这些数据，从而进一步显著提升自动形式化。我们的主要贡献如下：

- 我们构建了一个用于评估 Lean 4 中自动形式化的先驱数据集 FormL4，涵盖从自然语言问题到形式证明的完整过程。
- 我们提出了一种方法，利用形式语言的力量提供关于推理过程的精确反馈，从而增强 LLMs 的自动形式化能力。
- 我们进行了全面研究，旨在弥合 Lean 4 中非正式和正式推理之间的差距。

#### 图1说明
图1展示了基于 FormL4 训练的过程驱动自动形式化框架，并通过过程监督验证器（PSV）进一步增强。具体地，图中展示了四个主要过程：（1）通过提示 GPT-4 对从 Mathlib 4 中提取的定理进行非形式化，构建 FormL4 基准；（2）在 FormL4 上训练自动形式化模型，输出结果发送至 Lean 4 编译器以获得自动反馈；（3）编译反馈可以为自动形式化器提供过程级注释，用于训练有效的 PSV 模型；（4）为了进一步增强，自动形式化器随后通过验证器的反馈进行微调，而验证器可以从改进后的自动形式化器提供的高质量输出数据中再次受益。

### 相关工作
**使用 LLMs 进行自动形式化**
自动形式化是自动将非正式定理和证明转换为机器可验证格式的任务。早期的方法采用神经机器翻译方法将文本翻译为 Mizar 语言。最近 LLMs 的进展为自动形式化开辟了新可能性。研究人员探索了使用少样本提示使 LLMs 将数学问题翻译为形式格式，包括 Isabelle 和 Lean。其他研究采用了更结构化的方法来完成此任务。特别是，DSP 系统利用 LLMs 起草非正式证明并将其映射为形式化草图，使用自动定理证明系统填补证明草图中的缺失细节。此外，有一系列研究专注于在包含非正式和正式数学数据的大规模数据集上训练 LLMs，以评估其在自动形式化中的表现。与现有方法常常忽略 ITPs 中的详细编译信息不同，我们提出的方法利用 Lean 4 编译器的过程反馈来进一步提高 LLMs 的自动形式化能力。

**过程和结果监督**
最近的努力集中在通过验证器增强 LLMs 的数学推理能力，从多个候选答案中选择最佳答案。验证器主要有两种类型：结果监督验证器（OSV）和过程监督验证器（PSV）。OSV 基于最终答案的信号进行监督，而 PSV 则提供详细的反馈，评估单个推理步骤。尽管标注成本高昂，PSV 具有多个优势，使其优于 OSV。PSV 可以通过精确定位错误位置提供细粒度反馈，对于强化学习和自动纠正非常有价值。为减轻大量人工标注，最近的方法提出了一种使用蒙特卡洛树搜索的机器标注框架。这一标注过程需要大量计算资源，可能限制其使用。我们的方法利用形式语言自然提供的精确反馈，能够自动进行过程标注，无需大量人工或机器标注成本。

### FormL4：数据集构建
Lean 4 的快速发展，一种比其前身 Lean 3 具有显著改进的强大形式语言，迫切需要一个专门的基准来评估这一新环境中的自动形式化能力。现有数据集 MMA 主要集中在将问题翻译为陈述，忽略了将非正式解决方案翻译为证明的关键步骤。这一限制阻碍了充分利用 Lean 4 编译器的完整反馈，该编译器可以检查语法并验证证明中的推理。

为解决这一问题，我们引入了专门设计用于评估完整自动形式化过程的 FormL4。FormL4 超越了陈述翻译，涵盖了问题、答案、形式陈述和证明。这种全面的方法使得能够更准确地评估 LLM 理解 Lean 4 语法并在语言框架内进行逻辑推理的能力。在本节中，我们将介绍如何创建高质量的并行语料库（第3.1节）、保证质量（第3.2节）和拆分数据（第3.3节）。

#### 3.1 非形式化
我们利用 GPT-4 自动生成形式化数学陈述及其证明（形式化）的非正式描述。我们的方法超越了先前的工作，旨在将形式化内容的各个方面（陈述和证明）转换为每个数据点的自然语言。这是一个更具挑战性和计算成本更高的任务，要求 GPT-4 理解 Lean 4 的语法和每个证明中的逻辑推理步骤。

由于 GPT-4 直接生成 Lean 4 代码的能力有限（形式化比非形式化更难），我们从 mathlib4 库中提取用 Lean 4 格式编写的已建立定理（包括陈述和证明），并将它们输入 GPT-4 进行非形式化为自然语言描述。值得注意的是，Lean 4 中的 mathlib4 是可用的最广泛的形式数学库

之一。我们提供了具体的指示，提示 GPT-4 将这些定理转换为自然语言问题和答案，详见附录 D。

#### 3.2 策展过程
**预处理**
我们首先从 Mathlib 4 中提取 70,000 个定理，包括它们的陈述和证明。此过程基于 LeanDojo 的脚本，但进行了某些修改。我们采用 LeanDojo 代码从 Mathlib 4 中搜索并提取定理。然而，与原来专注于提取定理名称和策略用于定理证明不同，我们提取了陈述和证明的完整内容。我们不减少证明步骤，旨在提供全面的内容以改进自动形式化。

我们在证明中保留了“#align”命令，该命令由 Mathport 用于连接 Lean 3 名称到 Lean 4 名称。此包含旨在促进 GPT-4 在数据构建过程中的非形式化，因为我们假设 GPT-4 如果有与更熟悉的 Lean 3 语言的联系，将更好地理解 Lean 4 语言。

**后处理**
我们对 GPT-4 非形式化所得数据进行手动和自动筛选，确保提供高质量的自动形式化训练和测试数据。更多细节见附录 H.2。

我们提供一个“定理环境”，包括每个定理的全部依赖和前提，便于更容易的编译。具体来说，只需要将“定理环境”与自动形式化结果连接起来即可验证后者，无需深入研究 Mathlib 的细节。我们认为这种方法简化了编译过程。

#### 表1：FormL4 统计
测试集不一定需要 Lean 4 的地面真实陈述和证明，因为自动形式化输出可以通过编译器验证。实际测试集仅包含自然语言查询和答案，没有任何对应的 Lean 4 陈述。

| 数据集    | 大小   | Lean 4        | 自然语言          |
|-----------|--------|---------------|-------------------|
|           | # Chars, State. & Proof | # Chars, Q & A    |
| 平均      | 中位数 | 最小值        | 最大值            |
| 训练      | 14,510 | 210           | 179               | 101  | 5515  | 1900 | 1905 | 449  | 5706  |
| 随机测试  | 970    | 214           | 180               | 103  | 3242  | 1918 | 1921 | 677  | 4681  |
| 基础测试  | 981    | 205           | 165               | 111  | 2882  | 1781 | 1775 | 481  | 4856  |
| 实际测试  | 1,000  | -             | -                 | -    | -     | 893  | 763  | 401  | 3812  |

#### 3.3 数据集拆分
我们首先创建一个训练集和一个随机测试集，用于训练和评估 LLMs。两个集合都是通过从提取的 Lean 4 源文件中抽取定理（包括其陈述和证明）构建的，抽取后不放回池中。一个示例见附录 E。除了随机测试集外，我们还包括一个基础测试集和一个实际测试集以进行更全面的评估。基础测试集评估模型自动形式化基本定理的能力，几乎不依赖先验知识或已建立的引理。这些定理通常出现在像 Mathlib/Geometry/Euclidean/Basic.lean 这样的文件中，建立了基本的几何概念并证明了关于实内积空间和欧几里得仿射空间的简单结果。此外，我们通过从 Arithmo 测试集中收集 1000 个自然语言数学问题和答案构建实际测试集。表1详细列出了 FormL4 的统计数据，包括 Lean 4 和自然语言字符长度的数据点数量。有关数据集拆分和实际测试集环境的详细信息见附录 H。
